<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galaxy Network</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }

        #galaxy {
            position: absolute;
            touch-action: none;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(40px);
            border-radius: 14px;
            padding: 20px;
            width: 80%;
            max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: none;
        }

        .level-badge {
            background: linear-gradient(45deg, #e6e6ff, #ffe6ff);
            padding: 4px 10px;
            border-radius: 20px;
            color: #1C1C1E;
            font-weight: 500;
            font-size: 14px;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <canvas id="galaxy"></canvas>
    
    <div class="modal" id="starModal">
        <div id="starUsername"></div>
        <div class="level-badge" id="starLevel">Level 1</div>
        <div style="margin-top: 16px; font-size: 13px; opacity: 0.8;">
            Опыт: <span id="starXP">0/100</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let scale = 1;
        let offsetX = 0, offsetY = 0;
        let panning = false;
        let startX, startY;
        let stars = [];
        const canvas = document.getElementById('galaxy');
        const ctx = canvas.getContext('2d');

        // Цвета для уровней (пастельные)
        const levelColors = [
            '#FFFFFF', '#FFE6FF', '#E6E6FF', '#E6FFFF', '#FFE6E6',
            '#F0E6FF', '#E6F0FF', '#FFFAE6', '#E6FFE6', '#FFEDE6'
        ];

        // Инициализация Telegram
        tg.expand();
        tg.BackButton.hide();

        // Авторизация
        let user = null;
        if (tg.initDataUnsafe.user) {
            user = {
                id: tg.initDataUnsafe.user.id,
                username: tg.initDataUnsafe.user.username || `user_${tg.initDataUnsafe.user.id}`,
                level: 1,
                xp: 0
            };
            generateStar(user);
        }

        // Генерация звезды пользователя
        function generateStar(user) {
            const newStar = {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: 6,
                level: user.level,
                username: user.username,
                xp: user.xp,
                userId: user.id
            };

            // Проверка коллизий
            const hasCollision = stars.some(star => 
                Math.hypot(newStar.x - star.x, newStar.y - star.y) < 100
            );

            if (!hasCollision) {
                stars.push(newStar);
                draw();
                return true;
            }
            return false;
        }

        // Отрисовка
        function draw() {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(offsetX, offsetY);
            ctx.scale(scale, scale);

            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = getLevelColor(star.level);
                ctx.shadowColor = getLevelColor(star.level);
                ctx.shadowBlur = 15;
                ctx.fill();
            });

            ctx.restore();
        }

        // Цвет по уровню
        function getLevelColor(level) {
            return levelColors[Math.floor(level / 5) % levelColors.length];
        }

        // Обработка событий
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            const zoom = e.deltaY > 0 ? 0.9 : 1.1;
            scale = Math.min(Math.max(1, scale * zoom), 5);
            draw();
        });

        canvas.addEventListener('mousedown', e => {
            panning = true;
            startX = e.clientX - offsetX;
            startY = e.clientY - offsetY;
        });

        canvas.addEventListener('mousemove', e => {
            if (panning) {
                offsetX = e.clientX - startX;
                offsetY = e.clientY - startY;
                draw();
            }
        });

        canvas.addEventListener('mouseup', () => panning = false);

        // Клик по звезде
        canvas.addEventListener('click', e => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left - offsetX) / scale;
            const y = (e.clientY - rect.top - offsetY) / scale;

            stars.forEach(star => {
                if (Math.hypot(x - star.x, y - star.y) < 20) {
                    showStarInfo(star);
                }
            });
        });

        // Показать информацию о звезде
        function showStarInfo(star) {
            const modal = document.getElementById('starModal');
            document.getElementById('starUsername').textContent = `@${star.username}`;
            document.getElementById('starLevel').textContent = `Level ${star.level}`;
            document.getElementById('starXP').textContent = `${star.xp}/100`;
            modal.style.display = 'block';
        }

        // Закрытие модалки
        document.querySelector('.modal').addEventListener('click', () => {
            document.getElementById('starModal').style.display = 'none';
        });

        // Инициализация холста
        function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            draw();
        }

        window.addEventListener('load', init);
        window.addEventListener('resize', init);
    </script>
</body>
</html>
