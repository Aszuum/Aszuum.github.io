<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galaxy Network</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@octokit/core"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
        }

        #galaxy {
            position: absolute;
            touch-action: none;
            cursor: grab;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(40px);
            border-radius: 14px;
            padding: 20px;
            width: 85%;
            max-width: 300px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #fff;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .level-badge {
            background: linear-gradient(45deg, #e6e6ff, #ffe6ff);
            padding: 6px 14px;
            border-radius: 20px;
            color: #1C1C1E;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            margin: 8px 0;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.1);
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e6e6ff, #ffe6ff);
            transition: width 0.4s ease;
        }

        .user-stats {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <canvas id="galaxy"></canvas>
    
    <div class="modal" id="starModal">
        <div class="modal-header" id="starUsername"></div>
        <div class="level-badge" id="starLevel">Level 1</div>
        <div class="progress-container">
            <div class="progress-bar" id="starProgress"></div>
        </div>
        <div class="user-stats">
            <div>Опыт: <span id="starXP">0/100</span></div>
            <div>Звёзд: <span id="starCount">0</span></div>
            <div>Ранг: <span id="starRank">Новичок</span></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const Octokit = window.Octokit;
        
        // Конфигурация
        const GITHUB_TOKEN = 'YOUR_GITHUB_TOKEN';
        const REPO_NAME = 'YOUR_USERNAME/YOUR_REPO';
        const DATA_FILE = 'stars.json';
        
        let scale = 1;
        let offset = { x: 0, y: 0 };
        let stars = [];
        let currentUser = null;
        const canvas = document.getElementById('galaxy');
        const ctx = canvas.getContext('2d');
        const octokit = new Octokit({ auth: GITHUB_TOKEN });

        // Цвета по уровням (пастельные)
        const levelColors = {
            1: '#ffffff',
            5: '#ffe6ff',
            10: '#e6e6ff',
            15: '#e6ffff',
            20: '#ffede6',
            25: '#f0e6ff',
            30: '#e6f0ff',
            35: '#fffae6',
            40: '#e6ffe6',
            45: '#ffdbdb',
            50: '#dbffdb'
        };

        // Инициализация
        async function init() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // Загрузка данных
            try {
                const { data } = await octokit.request('GET /repos/{owner}/{repo}/contents/{path}', {
                    owner: REPO_NAME.split('/')[0],
                    repo: REPO_NAME.split('/')[1],
                    path: DATA_FILE
                });
                
                stars = JSON.parse(atob(data.content));
            } catch (e) {
                await initNewRepo();
            }

            // Авторизация в Telegram
            if (tg.initDataUnsafe.user) {
                currentUser = {
                    id: tg.initDataUnsafe.user.id,
                    username: tg.initDataUnsafe.user.username || `user_${tg.initDataUnsafe.user.id}`,
                    level: 1,
                    xp: 0,
                    stars: 0
                };
                
                if (!stars.find(s => s.user.id === currentUser.id)) {
                    await generateNewStar(currentUser);
                }
            }

            draw();
            initEvents();
        }

        // Генерация новой звезды
        async function generateNewStar(user) {
            const newStar = {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: 6,
                user: {
                    id: user.id,
                    username: user.username,
                    level: 1,
                    xp: 0,
                    stars: 0
                },
                color: getLevelColor(1)
            };

            // Проверка коллизий
            let collision = false;
            for (const star of stars) {
                const dx = star.x - newStar.x;
                const dy = star.y - newStar.y;
                if (Math.sqrt(dx*dx + dy*dy) < 100) {
                    collision = true;
                    break;
                }
            }

            if (!collision) {
                stars.push(newStar);
                await saveStars();
                return true;
            }
            return false;
        }

        // Сохранение звёзд
        async function saveStars() {
            try {
                await octokit.request('PUT /repos/{owner}/{repo}/contents/{path}', {
                    owner: REPO_NAME.split('/')[0],
                    repo: REPO_NAME.split('/')[1],
                    path: DATA_FILE,
                    message: 'Update stars data',
                    content: btoa(JSON.stringify(stars)),
                    sha: await getFileSha()
                });
            } catch (e) {
                console.error('Ошибка сохранения:', e);
            }
        }

        // Отрисовка
        function draw() {
            ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.translate(offset.x, offset.y);
            ctx.scale(scale, scale);

            stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = getLevelColor(star.user.level);
                ctx.shadowColor = getLevelColor(star.user.level);
                ctx.shadowBlur = 15;
                ctx.fill();
            });

            ctx.restore();
        }

        // Цвет по уровню
        function getLevelColor(level) {
            const levels = Object.keys(levelColors).sort((a,b) => a - b);
            let color = levelColors[1];
            
            for (const l of levels) {
                if (level >= l) color = levelColors[l];
            }
            return color;
        }

        // События
        function initEvents() {
            // Зум/Пан
            canvas.addEventListener('wheel', e => {
                e.preventDefault();
                const zoom = e.deltaY > 0 ? 0.9 : 1.1;
                scale = Math.min(Math.max(1, scale * zoom), 5);
                draw();
            });

            let isPanning = false;
            let startPos = { x: 0, y: 0 };

            canvas.addEventListener('mousedown', e => {
                isPanning = true;
                startPos = { x: e.clientX - offset.x, y: e.clientY - offset.y };
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', e => {
                if (isPanning) {
                    offset.x = e.clientX - startPos.x;
                    offset.y = e.clientY - startPos.y;
                    draw();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isPanning = false;
                canvas.style.cursor = 'grab';
            });

            // Клик по звезде
            canvas.addEventListener('click', async e => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left - offset.x) / scale;
                const y = (e.clientY - rect.top - offset.y) / scale;

                for (const star of stars) {
                    const dx = x - star.x;
                    const dy = y - star.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 20) {
                        showStarInfo(star);
                        return;
                    }
                }
            });
        }

        // Показать информацию
        function showStarInfo(star) {
            const modal = document.getElementById('starModal');
            modal.style.display = 'block';
            
            document.getElementById('starUsername').textContent = `@${star.user.username}`;
            document.getElementById('starLevel').textContent = `Level ${star.user.level}`;
            document.getElementById('starXP').textContent = `${star.user.xp}/${getRequiredXP(star.user.level)}`;
            document.getElementById('starCount').textContent = star.user.stars;
            document.getElementById('starRank').textContent = getRank(star.user.level);
            document.getElementById('starProgress').style.width = 
                `${(star.user.xp / getRequiredXP(star.user.level)) * 100}%`;
        }

        // Вспомогательные функции
        function getRequiredXP(level) {
            if (level <= 26) return 100;
            if (level <= 45) return 204;
            if (level <= 94) return 300;
            return 565;
        }

        function getRank(level) {
            if (level < 5) return 'Новичок';
            if (level < 15) return 'Исследователь';
            if (level < 30) return 'Мастер звёзд';
            return 'Галактический лидер';
        }

        // Запуск
        tg.ready();
        tg.expand();
        init();
    </script>
</body>
</html>
